#!/usr/bin/env bash
set -e

nix-instantiate --eval --strict --json -A pythonng.index \
  | jq -r '.[] | select(.pname) | [.pname, .version] | join("==")' \
  > pypi-requirements.txt

pip2nix --no-print-expr -r pypi-requirements.txt "$@"
rm pypi-requirements.txt

cat <<-EOF > python-modules/pypi-packages.nix
{ pkgs, callPackage }:

self:

{$(find cache -name '*.nix' -exec cat {} +)
}
EOF

if [ ! -f requirements.txt ]; then exit; fi

cat <<-EOF
self: super:

{
$(while read -r item; do
  item=${item%;*}
  key=${item%==*}
  key=${key//./-}
  key=${key//_/-}
  version=${item#*==}
  version=${version//-/_}
  version=${version//./_}
  echo "  $key = self.${key}_${version};"
done < requirements.txt)
}
EOF
